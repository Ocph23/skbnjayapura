@layout AdminLayout
@page "/admin/skbn"

@attribute [Authorize(Roles = "Admin")]

<div class="noprint container-xxl flex-grow-1 container-p-y">
    <div class="card">
        <div style=" display:flex;justify-content:space-between; align-items:center">
            <h5 class="card-header">Data SKBN</h5>
            <div class="d-flex">
                  <InputDate @bind-Value="startDate" onchange="@StartDateChange" class="form-control"></InputDate>
                  <InputDate @bind-Value="endDate" class="form-control"></InputDate>
            </div>
        </div>
        <div class="table-responsive text-nowrap">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nomor SKBN</th>
                        <th>Pemohon</th>
                        <th>Keperluan</th>
                        <th>Berlaku</th>
                        <th>Ditetapkan</th>
                        <th>Diambil</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody class="table-border-bottom-0">

                    @if (permohonan != null)
                    {
                        @foreach (var item in permohonan.Select((data, index) => new { data, index }))
                        {
                            <tr>
                                <td>@(item.index + 1)</td>
                                <td>@item.data.Nomor</td>
                                <td>@item.data.Profile.Nama</td>
                                <td>@item.data.Keperluan</td>
                                <td>@($"{item.data.Mulai.ToString("dd/MM/yyyy")} - {item.data.Selesai.ToString("dd/MM/yyyy")}")</td>
                                <td>@($"{item.data.TanggalPenetapan.ToString("dd/MM/yyyy")}")</td>
                                <td>@(string.IsNullOrEmpty(item.data.DiambilOleh)?"Belum":"Sudah")</td>
                                <td>
                                    <div class="dropdown" style="position:inherit !important">
                                        <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                            <i class="bx bx-dots-vertical-rounded"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" @onclick="@(()=>PrintAction(item.data))"><i class="bx bx-printer me-1"></i> Cetak</a>
                                            <a class="dropdown-item" @onclick="@(()=> EditAction(item.data))"><i class="bx bx-edit-alt me-1"></i> Pengambilan</a>
                                        </div>
                                    </div>
                                </td>
                            </tr>

                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<Modal @ref="modal" Title="Pengambilan" IsVerticallyCentered=true>
    <BodyTemplate>
        <EditForm Model="@pengambilan" OnValidSubmit="SaveAction">
            <Morris.Blazor.Validation.Validate ValidationProperties=@(ValidationProperties.Set.FluentValidator<PengambilanValidator>()) />
            <div class="mb-3">
                <label for="email" class="form-label">Diambil Oleh </label>
                <InputText type="text" @bind-Value="pengambilan.Nama" class="form-control"></InputText>
                <ValidationMessage For="@(() => pengambilan.Nama)" />
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Tanggal</label>
                <InputDate @bind-Value="pengambilan.Tanggal" class="form-control"></InputDate>
                <ValidationMessage For="@(() => pengambilan.Tanggal)" />
            </div>
            <div class="mb-3" style="display:flex;justify-content:end; gap:2px">
                <Button Color="ButtonColor.Secondary" @onclick="OnHideModalClick">Close</Button>
                <Button Type="ButtonType.Submit" Color="ButtonColor.Primary">Save</Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

<ConfirmDialog @ref="confirmDialog" />

<CetakSKBN model="@model"></CetakSKBN>


@inject HttpClient httpClient
@inject ILocalStorageService localService
@inject IJSRuntime JS

@code {
    [Inject] protected ToastService ToastService { get; set; }
    ICollection<SKBNModel> permohonan;
    ICollection<SKBNModel> source;
    SKBNModel model;
    Pengambilan pengambilan;
    private Modal modal;
    private ConfirmDialog confirmDialog;

    DateTime? startDate= DateTime.Now;
    DateTime? endDate;


    Task StartDateChange(){
        
    }

    protected override async Task OnInitializedAsync()
    {
        await httpClient.SetToken(localService);
        var response = await httpClient.GetAsync("api/permohonan/skbn");

        if (response.IsSuccessStatusCode)
        {
            source = (await response.GetResult<IEnumerable<SKBNModel>>()).ToList();
        }
        permohonan = source.ToList();
    }

    async Task EditAction(SKBNModel data)
    {
        pengambilan = new Pengambilan { Id= data.Id, Nama = data.DiambilOleh, Tanggal = data.TanggalPengambilan == null ? DateTime.Now : data.TanggalPengambilan.Value };
        await modal.ShowAsync();
    }

    async Task SaveAction()
    {
     
        try
        {
            var httpResponse = await httpClient.PostAsJsonAsync<Pengambilan>("api/permohonan/pengambilan", pengambilan);
            if (httpResponse.IsSuccessStatusCode)
            {
                var result = await httpResponse.GetResult<Persyaratan>();
                if (result == null)
                    throw new SystemException("Data tidak berhasil disimpan !");
                var dataToSave = model with { DiambilOleh = pengambilan.Nama!, TanggalPengambilan = pengambilan.Tanggal };
                ToastService.Notify(new ToastMessage(ToastType.Success, "Success", "Berhasil !"));
                await modal.HideAsync();
                return;
            }

            throw new SystemException(await httpResponse.Error());
        }
        catch (Exception ex)
        {

            throw;
        }
    }

    async Task PrintAction(SKBNModel value)
    {
        model = value;
        StateHasChanged();
        await Task.Delay(500);
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task OnShowModalClick()
    {
        await modal?.ShowAsync();
    }
    private async Task OnHideModalClick()
    {
        await modal?.HideAsync();
    }


}